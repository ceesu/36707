---
title: "Science Forums"
author: "Cathy Su"
date: "19/10/2019"
output:
  pdf_document: default
  html_document:
    fig_caption: yes
    highlight: tango
bibliography: report2.bib
---

```{r setup, include=FALSE}
#http://rosmarus.refsmmat.com/datasets/datasets/hormone-diversity/ 
  
knitr::opts_chunk$set(echo = FALSE, width.cutoff=60, fig.pos = 'H')
set.seed(1234)

# libraries
library(tidyverse)
library(lattice)
library(dagitty)
library(reshape2)
library(grid)
library(gridExtra)
library("ggpubr")
library(knitr)
# data
data <- read.csv("../data/sfn-sample.csv",
                     sep = ",", 
                     header = T)
# early year
data$year_started <- as.numeric(sub("-.*", "", data$startdate))

# topics
table <- read.csv("../data/forum_id.csv",
                     sep = ",", 
                     header = T)
# add a NA level to the table.

topics <- separate_rows(table, Forum.IDs, sep = ",")
topics$Forum.IDs <- as.numeric(topics$Forum.IDs)
setdiff(topics$Forum.IDs, data$forum_id)
data$category <- plyr::mapvalues(data$forum_id,
                              from = topics$Forum.IDs,
                              to = as.character(topics$Category)) 
data$category <- as.factor(data$category)
levels(data$category)[1:32] <- NA
#test <- lapply(data$category, function(x) as.character(as.numeric(x)))
# proportion_deleted
data$proportion_deleted <- data$deleted_posts/data$posts
data$post_rate <- 0
data$post_rate[data$duration > 0]<- data$posts[data$duration > 0]/(data$duration[data$duration > 0]) # if the denom is zero, set post rate to zero


# > colnames(data)
#  [1] "tid"                "state"              "posts"              "views"             
#  [5] "duration"           "startdate"          "forum_id"           "authors"           
#  [9] "deleted_posts"      "not_deleted"        "pinned"             "author_exp"        
# [13] "author_banned"      "year_started"       "topic"              "proportion_deleted"
# [17] "post_rate"

```

## Executive Summary

Moderators at online forums are always interested in growing the participation while keeping a high quality discussion. Therefore, at times it becomes necessary to delete posts that might become problematic. The purpose of this study was to assess the variables that may influence which topics need to be closed on this online forum. It's been hypothesized that the type of post authors, topic of the post and XXX are factors in which discussions will need to be shut down. Discussion topics were randomly sampled from ScienceForums.Net (SFN). XXX studies passed the inclusion criteria and XXX variables represented potential contributing factors towards whether discussions will need to be closed. XXX proved to be the most consistent moderator of I-PA, suggesting that much of the discordance may be from motivational flux between initial intention and eventual behaviour. Anticipated regret and conscientiousness also had evidence as the moderators of I-PA. Perceived control/self-efficacy, planning, extraversion, habit and environmental proximity to recreation showed some evidence for moderation, while gender, agreeableness, openness, body mass index and ethnicity did not appear to moderate I-PA. The findings demonstrate that traditional intention theories may need augmentation to better account for the evidence present in I-PA discordance.

## Introduction

### Causal diagram 

```{r causal, fig.width=9, fig.height=2.5, echo=FALSE, fig.cap="\\label{fig:cause} Causal diagram illustrates hypothesized relationships of experimental variables involved in relationship between testosterone and final group performance."}

g <- dagitty('dag {
    state [pos="0,1"]
    proportion_deleted [pos="1,0.5"]
    views [pos="2,2"]
    duration [pos="1,1"]
    startdate [pos="1.2,0"]
    forum_id [pos="2,0.5"]
    author_diversity [pos="0,2"]
    pinned [pos="-1,1.5"]
    author_exp  [pos="-1,2.0"]
    not_deleted [pos="0,2"]
    
    forum_id -> author_diversity 
    forum_id -> proportion_deleted -> views
    author_diversity  -> proportion_deleted 
}')

plot(g)
```

## Methods

### removal of outliers


### Handling missing data 

### Calculation of additional variables 

For the substantive questions we calculated some new variables as follows:
* We extracted the 'year_started' of each topic as replacement for using the full 'startdate' which contains a lot more precise time than we need. 
* the 'proportion_deleted' is the number of deleted divided by total posts in the topic.
* The 'post_rate' is the number of posts divided by the 'duration' of the topic. If 'duration' is zero, the 'post_rate' was also assigned zero.


### Model building


## Exploratory Data Analysis 

### Univariate variable distributions

Figure \ref{fig:uni} shows the distribution of forum topics which fall into each category for the binary variables. This shows us that very few forum topics are deleted from view, closed, pinned or started by a banned author.

```{r uni, fig.width=5, fig.height=5, echo=FALSE, message=FALSE, warning= FALSE,fig.cap="\\label{fig:uni} Univariate correlations of categorical variables."}
theme_hw <- theme(plot.title = element_text(hjust = 0.5),
        #axis.text.x=element_blank(),
        axis.ticks.x=element_blank()
       # panel.grid.major =   element_line(colour = "gray",size=0.5)
  )
p1 <-ggplot(data, aes(x= as.factor(not_deleted)))+
  geom_bar()#+theme_hw #+ ylab("Testosterone in pg/mL")
p2 <-ggplot(data, aes(x= as.factor(state)))+
  geom_bar()+theme_hw #+ ylab("Log(Testosterone in pg/mL)")
p3 <-ggplot(data, aes(x=as.factor(pinned)))+
  geom_bar()+theme_hw #+ ylab("Cortisol in nMol/L")
p4 <-ggplot(data, aes(x=as.factor(author_banned)))+
  geom_bar()+theme_hw #+ ylab("Log(cortisol in nMol/L)")
grid.arrange(p1, p2, 
             p3, p4, 
             ncol = 2)
```
Additionally, although forum type is an important variable of interest, we found that there were many forum ids which were missing a categorization. This proportion is shown in the top bar of Figure \ref{fig:bar}. 

```{r bar, fig.width=5, fig.height=5, echo=FALSE, message=FALSE, warning= FALSE,fig.cap="\\label{fig:bar} Breakdown of forums by topic, showing a portion of forums do not have any assigned topic."}

p1 <-ggplot(data, aes(x=category))+
  geom_bar() + coord_flip()#+theme_hw #+ ylab("Testosterone in pg/mL")
grid.arrange(p1,  
             ncol = 1)
```

We then examined the pairwise correlation of the continuous variables which is shown in Figure \ref{fig:pairs}. There appears to be no collinearity and generally only weak correlation among these variables, but we can observe the following trends:
* Looking across the diagonal, all of the continuous variables with the exception of 'year_started' have a significant right skew.
* 'posts' and 'views' correlate positively with author diversity, author experience and topic duration but negatively with 'year_started', 'proportion_deleted' and 'post_rate'. 
* 

```{r eda, fig.width=10, fig.height=10, echo=FALSE, message=FALSE, warning= FALSE,fig.cap="\\label{fig:pairs}Pairwise correlations of important variables including their Pearson correlation coefficient. Significant correlations are marked by the corresponding number of astericks."}
# check relationships of all variables of interest
vars <- colnames(data)[c(2:13)]
#cor(team_dat)
#pairs(team_dat[vars], pch = 19,  lower.panel=NULL)
#library("PerformanceAnalytics")
#chart.Correlation(data[vars], pch=19)
quant_vars <- colnames(data)[c(3:5,8,12, 14, 16:17)]
#summary(data)
library(GGally)
ggpairs(data[,quant_vars])
```


## Q1. Relationship between views and posts

We saw in Figure \ref{fig:pairs} that views and posts are weakly positively correlated. In figure \ref{fig:q1} we breaking this down by subforum for those topics which have a categorization. 

```{r q1, fig.width=5, fig.height=5, echo=FALSE, message=FALSE, warning= FALSE,fig.cap="\\label{fig:q1} Breakdown of forums by topic, showing a portion of forums do not have any assigned topic."}

p1 <-ggplot(data, aes(x=category))+
  geom_bar() + coord_flip()#+theme_hw #+ ylab("Testosterone in pg/mL")
grid.arrange(p1,  
             ncol = 1)
```

## Q2. Diverse discussions closed or deleted

Number of distinct authors who participated in the discussion.

```{r test, fig.width=6, fig.height=6, echo=FALSE, message=FALSE, warning= FALSE, fig.cap="\\label{fig:test}Distributions of testosterone and log testosterone levels in each team"}
p1 <-ggplot(data, aes(x= team.id, y=Testosterone))+
  geom_boxplot()+theme_hw + ylab("Testosterone in pg/mL")
```

## Q3 discussions with proportionally more deleted posts tend to get closed more often

The univariate distributions of the group level variables is given across the diagonal in Figure \ref{fig:pairs}. We saw that in particular, our diversity score appears bimodal. Although our score is calculated differently, [@Akinola2018] classified diversity score into two bins in their faultline analysis. This suggests that our diversity score is reasonable since it may also reflect some intrinsic bimodality present in the data. 

We visualized the correlation matrix including the Pearson correlation coefficients (upper right half) between important variables in Figure \ref{fig:pairs}. Based on the correlation coefficients, we do not need to remove variables based on collinearity. Additionally, it seems that 

Right away we can make the following observations about the key variables:

* performance appears correlated with proportion of females and testosterone.
* testosterone appears correlated with cortisol, average age, proportion of females, time of day, performance and team size.
* diversity score appears correlated with team size.

Based on this we knew that in addition to final.performance, avg.log.testosterone, avg.log.cortisol and diversity.score we should consider whether to incorporate the four additional variables proportion.female, avg.age/age.variance, time.of.day, and team.size in our models.


## Results

The results discussed by the original study [@Akinola2018] include that:

* considered in isolation, group diversity and testosterone are not significantly correlated with performance.
* when group diversity was l

### Model selection 

Since the authors studied 2-way interactions, to choose the terms in the model we first performed model selection using best subsets and cross validation. We start off with all of the group level variables as depicted in Figure \ref{fig:pairs}, adding based on the causal graph and the authors' work the following interaction terms:


