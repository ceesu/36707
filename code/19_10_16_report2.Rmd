---
title: "Science Forums"
author: "Cathy Su"
date: "19/10/2019"
output:
  pdf_document: default
  html_document:
    fig_caption: yes
    highlight: tango
bibliography: report2.bib
---

```{r setup, include=FALSE}
#http://rosmarus.refsmmat.com/datasets/datasets/hormone-diversity/ 

# libraries
library(stargazer)
library(tidyverse)
library(lattice)
library(dagitty)
library(reshape2)
library(grid)
library(gridExtra)
library("ggpubr")
library(knitr)
library(pander)
library(sjPlot)
library(sjmisc)

opts_knit$set(eval.after = 'fig.cap')
knitr::opts_chunk$set(echo = FALSE, width.cutoff=60, fig.pos = 'H')
set.seed(1234)

mod_stargazer <- function(...){
  output <- capture.output(stargazer(...))
  # The first three lines are the ones we want to remove...
  output <- output[4:length(output)]
  # cat out the results - this is essentially just what stargazer does too
  cat(paste(output, collapse = "\n"), "\n")
}

# data
data <- read.csv("../data/sfn-sample.csv",
                     sep = ",", 
                    header = T)

####### NEW VARIABLES
# early year
data$startdate <- as.numeric(as.POSIXct(data$startdate)) -1000000000

# topics
table <- read.csv("../data/forum_id.csv",
                     sep = ",", 
                     header = T)
# add a NA level to the table.

topics <- separate_rows(table, Forum.IDs, sep = ",")
topics$Forum.IDs <- as.numeric(topics$Forum.IDs)
setdiff(topics$Forum.IDs, data$forum_id)
data$category <- plyr::mapvalues(data$forum_id,
                              from = topics$Forum.IDs,
                              to = as.character(topics$Category)) 
data$category <- as.factor(data$category)
levels(data$category)[1:32] <- NA
#test <- lapply(data$category, function(x) as.character(as.numeric(x)))
# proportion_deleted
data$proportion_deleted <- data$deleted_posts/data$posts
data$post_rate <- 0
data$post_rate[data$duration > 0]<- data$posts[data$duration > 0]/(data$duration[data$duration > 0]) # if the denom is zero, set post rate to zero


# > colnames(data)
#  [1] "tid"                "state"              "posts"              "views"             
#  [5] "duration"           "startdate"          "forum_id"           "authors"           
#  [9] "deleted_posts"      "not_deleted"        "pinned"             "author_exp"        
# [13] "author_banned"      "year_started"       "topic"              "proportion_deleted"
# [17] "post_rate"


####### CLEANED DATA
dat <- data[data$pinned ==0 & data$not_deleted == 1 & !is.na(data$category) & data$posts <250  ,]
#& data$views >0
dat$category <- as.factor(dat$category)
```

## Executive Summary

Moderators at online forums are always interested in growing the participation while keeping a high quality discussion. Therefore, at times it becomes necessary to delete posts that might become problematic. The purpose of this study was to assess the variables that may influence which topics need to be closed on this online forum. It's been hypothesized that the type of post authors, topic of the post and XXX are factors in which discussions will need to be shut down. Discussion topics were randomly sampled from ScienceForums.Net (SFN). XXX studies passed the inclusion criteria and XXX variables represented potential contributing factors towards whether discussions will need to be closed. XXX proved to be the most consistent moderator of I-PA, suggesting that much of the discordance may be from motivational flux between initial intention and eventual behaviour. Anticipated regret and conscientiousness also had evidence as the moderators of I-PA. Perceived control/self-efficacy, planning, extraversion, habit and environmental proximity to recreation showed some evidence for moderation, while gender, agreeableness, openness, body mass index and ethnicity did not appear to moderate I-PA. The findings demonstrate that traditional intention theories may need augmentation to better account for the evidence present in I-PA discordance.

## Introduction


## Methods

### Removal of outliers and missing data

Related to Figure \ref{fig:uni}, we removed the topics which are deleted from view or pinned since there seem to be very few cases so we may not be able to properly model what happened there. Related to Figure \ref{fig:bar}, the only missing values in the data came from topics without categorization, which were also removed because we want to know the impact of the subforum type.

### Calculation of additional variables 

For the substantive questions we calculated some new variables as follows:
* We converted the 'startdate' into POSIXct format which allows us to compare time elapsed precisely between dates.
* the 'proportion_deleted' is the number of deleted divided by total posts in the topic which is necessary for Q1.
* The 'post_rate' is the number of posts divided by the 'duration' of the topic. If 'duration' is zero, the 'post_rate' was also assigned zero.

## Exploratory Data Analysis 

### Causal diagram 

Moderators would like to know which topics may need to be closed. We may hypothesize that topics will need to be closed mainly due to offensive posts, or due to controversial discussion. Based on this, author diversity ('authors') could be important to affect the relationship between proportion of deleted posts, length of the discussion and topic status (open or closed) as in Figure \ref{fig:cause}. This figure also shows that views on a topic 

```{r causal, fig.width=3, fig.height=1, echo=FALSE, fig.cap="\\label{fig:cause} Causal diagram illustrates hypothesized relationships of experimental variables involved in relationship between proportion of deleted posts and topic status."}
#pinned [pos="-1,1.5"]
# author_exp  [pos="-1,2.0"]
# startdate [pos="1.2,0"]
# views [pos="2,2"]
# topic_category [pos="2,0.5"]
#  
g <- dagitty('dag {
    state [pos="0,1"]
    authors [pos="1,0.5"]
    proportion_deleted [pos="1,1"]
    topic_category [pos="2,0.5"]
    views [pos="2,1"]
    posts [pos="2,0.75"]
    startdate [pos="0,0.5"]
    
    startdate ->posts <- topic_category -> authors-> posts-> state
    state -> posts ->views <-startdate
    proportion_deleted -> state
    authors -> proportion_deleted 
}')

plot(g)
```

### Univariate variable distributions

Figure \ref{fig:uni} shows the distribution of topics which fall into each category for the binary variables. This shows us that almost no topics are deleted from view or pinned. However a small portion of topics (<10%) are closed, or started by a banned author.

```{r uni, fig.width=5, fig.height=2, echo=FALSE, message=FALSE, warning= FALSE,fig.cap="\\label{fig:uni} Distribution of binary categorical variables."}
theme_hw <- theme(plot.title = element_text(hjust = 0.5),
        #axis.text.x=element_blank(),
        axis.ticks.x=element_blank()
       # panel.grid.major =   element_line(colour = "gray",size=0.5)
  )
p1 <-ggplot(data, aes(x= as.factor(not_deleted)))+
  geom_bar()#+theme_hw #+ ylab("Testosterone in pg/mL")
p2 <-ggplot(data, aes(x= as.factor(state)))+
  geom_bar()+theme_hw #+ ylab("Log(Testosterone in pg/mL)")
p3 <-ggplot(data, aes(x=as.factor(pinned)))+
  geom_bar()+theme_hw #+ ylab("Cortisol in nMol/L")
p4 <-ggplot(data, aes(x=as.factor(author_banned)))+
  geom_bar()+theme_hw #+ ylab("Log(cortisol in nMol/L)")
grid.arrange(p2,p4,p1,  
             p3, 
             ncol = 4)
```
Additionally, although topic type is an important variable of interest, we found that there were many topic ids which were missing a categorization (about 10%, see the top boxplot of Figure \ref{fig:bar}) which we removed. Additionally the number of posts was very right skewed, and we trimmed the few topics with posts in excess of 250 since these seem like extreme outliers based on Figure \ref{fig:bar}). The distribution of views was similarly right skewed to the distribution of posts.

```{r bar, fig.width=5, fig.height=5, echo=FALSE, message=FALSE, warning= FALSE,fig.cap="\\label{fig:bar} Breakdown of posts by subforum, showing many outlier topics which have an extreme number of posts."}

p1 <-ggplot(dat, aes(x = category, y= views))+
  geom_boxplot() + coord_flip()#+theme_hw #+ ylab("Testosterone in pg/mL")
  
  
  #geom_boxplot(mapping =aes(x=category, y = ..prop.., group = 1),  stat = "count") + coord_flip()#+theme_hw #+ ylab("Testosterone in pg/mL")
grid.arrange(p1,  
             ncol = 1)
```

We then examined the pairwise correlation of the continuous variables and saw that aside from 'startdate' many of these variables are zero inflated counts which is shown in Figure \ref{fig:pairs}. This suggests that a poisson glm with log link might be appropriate. We also see a logical relationship between duration, author_exp and startdate. If time increases by one unit in startdate, the number of views or posts may not necessarily increase which suggests that we may not want to use it as an offset.

```{r eda, fig.width=10, fig.height=10, echo=FALSE, message=FALSE, warning= FALSE,fig.cap="\\label{fig:pairs} Pairwise correlations of important variables including their Pearson correlation coefficient. Significant correlations are marked by the corresponding number of red astericks. We can see from the univariate distributions (graphs on the diagonal) that with the exception of 'year_started', these variables are mostly "}
# check relationships of all variables of interest
#vars <- colnames(data)[c(2:13)]
#cor(team_dat)
#pairs(team_dat[vars], pch = 19,  lower.panel=NULL)
library("PerformanceAnalytics")

vars <- colnames(data)[c(3:6,8,12, 15:16)]
chart.Correlation(data[vars], pch=19)
#summary(data)
#library(GGally)
#ggpairs(data[,quant_vars])
```

## Q1. Relationship between views and posts

To determine the relationship between views and posts, we start by fitting the glm with the also take a look at the residuals of the model in Figure \ref{fig:q1}. It's clear that topic 8346 is a really abnormal case. We break this down by subforum for those topics which have a categorization. we summarize linear models of these two variables with and without the additional variable 'category' which relates to their subforum in Table \ref{fig:q1}.

```{r q1, fig.width=5, fig.height=5, echo=FALSE, message=FALSE, warning= FALSE,fig.cap="\\label{fig:q1} Breakdown of forums by topic, showing a portion of forums do not have any assigned topic."}
# > which(rownames(dat) == 8346,)
# [1] 7519

#temp <- dat[-7519,]
mod <- glm(views ~ posts + offset(log(startdate)), 
           family =quasipoisson(log), 
           data = dat)
par(mfrow=c(2,2))
plot(mod)

mod1 <-glm(views ~ posts + category+ startdate, 
           family =quasipoisson(log), 
           data = dat)
par(mfrow=c(2,2))
plot(mod1)

mod2 <-glm(views ~ posts + category+ offset(log(startdate)), 
           family =quasipoisson(log), 
           data = dat)
par(mfrow=c(2,2))
plot(mod2)

Anova(model.p, 
      type="II", 
      test="LR")

stargazer(mod,
          mod2,
         # model,
        # object.names = TRUE,
         column.labels = c("base", "model 2", "model 3"),
          model.names = FALSE,
        model.numbers = FALSE,
          flip = TRUE,
          header=FALSE, type = "latex",
          intercept.bottom = FALSE, out.header = FALSE,
          label = "tab:regression",
          font.size="small",
          column.sep.width = "1pt",
          single.row = TRUE,
          omit.table.layout = "n",
          #model.names = FALSE, # remove model names
          title = "Comparing models of relationship between views and posts")
```

## Q2. Diverse discussions closed or deleted

Number of distinct authors who participated in the discussion.

```{r test, fig.width=6, fig.height=6, echo=FALSE, message=FALSE, warning= FALSE, fig.cap="\\label{fig:test}Distributions of testosterone and log testosterone levels in each team"}
p1 <-ggplot(data, aes(x= team.id, y=Testosterone))+
  geom_boxplot()+theme_hw + ylab("Testosterone in pg/mL")
```

## Q3 discussions with proportionally more deleted posts tend to get closed more often

The univariate distributions of the group level variables is given across the diagonal in Figure \ref{fig:pairs}. We saw that in particular, our diversity score appears bimodal. Although our score is calculated differently, [@Akinola2018] classified diversity score into two bins in their faultline analysis. This suggests that our diversity score is reasonable since it may also reflect some intrinsic bimodality present in the data. 

We visualized the correlation matrix including the Pearson correlation coefficients (upper right half) between important variables in Figure \ref{fig:pairs}. Based on the correlation coefficients, we do not need to remove variables based on collinearity. Additionally, it seems that 

Right away we can make the following observations about the key variables:

* performance appears correlated with proportion of females and testosterone.
* testosterone appears correlated with cortisol, average age, proportion of females, time of day, performance and team size.
* diversity score appears correlated with team size.

Based on this we knew that in addition to final.performance, avg.log.testosterone, avg.log.cortisol and diversity.score we should consider whether to incorporate the four additional variables proportion.female, avg.age/age.variance, time.of.day, and team.size in our models.

## Results

The results discussed by the original study [@Akinola2018] include that:

* considered in isolation, group diversity and testosterone are not significantly correlated with performance.
* when group diversity was l

### Model selection 

Since the authors studied 2-way interactions, to choose the terms in the model we first performed model selection using best subsets and cross validation. We start off with all of the group level variables as depicted in Figure \ref{fig:pairs}, adding based on the causal graph and the authors' work the following interaction terms:


